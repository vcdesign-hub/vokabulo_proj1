---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { SUPPORTED_LANGS, DEFAULT_LANG, isValidLanguage } from '../../utils/i18n';
import { generateFallbackDescription } from '../../utils/seo';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';
import { marked } from 'marked';

export function getStaticPaths() {
  return SUPPORTED_LANGS.map(lang => ({
    params: { lang }
  }));
}

const { lang } = Astro.params;

if (!isValidLanguage(lang)) {
  return Astro.redirect(`/${DEFAULT_LANG}/privacy`);
}

// Load markdown content
const contentPath = join(process.cwd(), 'content', 'pages', lang, 'privacy.md');
let content = '';
let title = 'Privacy Policy Â· Vokabulo';
let description = '';

if (existsSync(contentPath)) {
  const fileContent = readFileSync(contentPath, 'utf-8');
  const frontmatterMatch = fileContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
  if (frontmatterMatch) {
    const frontmatter = frontmatterMatch[1];
    const markdown = frontmatterMatch[2];
    const titleMatch = frontmatter.match(/title:\s*["'](.*)["']/);
    if (titleMatch) title = titleMatch[1];
    const descMatch = frontmatter.match(/description:\s*["'](.*)["']/);
    if (descMatch) description = descMatch[1];
    
    // Generate fallback description if not in frontmatter
    if (!description && markdown) {
      description = generateFallbackDescription(markdown, 160);
    }
    
    content = marked.parse(markdown);
  } else {
    content = marked.parse(fileContent);
  }
}
---

<BaseLayout title={title} description={description} currentLang={lang} currentPath="/privacy">
  <style is:global>
    /* Privacy Policy page-specific styles */
    :root {
      --ink: #111827;
      --muted: #374151;
    }

    .page {
      max-width: 750px;
      margin: 0 auto;
      padding: 140px 24px 48px;
    }

    main {
      margin-top: 0;
      background: transparent;
      border: none;
      border-radius: 0;
      padding: 0;
      box-shadow: none;
    }

    h1 {
      margin: 0 0 32px;
      font-size: 32px;
      font-weight: 700;
      line-height: 1.2;
      color: var(--ink);
      letter-spacing: -0.02em;
    }

    h2 {
      margin: 48px 0 16px;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
      color: var(--ink);
      letter-spacing: -0.01em;
    }

    p {
      margin: 0 0 16px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 16px;
      font-weight: 400;
    }

    p:last-of-type {
      margin-bottom: 0;
    }

    ul {
      margin: 0 0 24px;
      padding-left: 24px;
      list-style-type: disc;
      list-style-position: outside;
    }

    li {
      margin: 0 0 8px;
      padding-left: 0;
      color: var(--muted);
      line-height: 1.6;
      font-size: 16px;
      font-weight: 400;
      display: list-item;
      list-style-type: disc;
    }

    li:last-child {
      margin-bottom: 0;
    }

    a {
      color: #2563eb;
      text-decoration: underline;
    }

    a:hover {
      color: #1d4ed8;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: #f6f7fb;
      }
    }

    .theme-dark main {
      background: transparent;
      border: none;
      box-shadow: none;
    }
  </style>

  <div class="page">
    <main>
      <Fragment set:html={content} />
    </main>
  </div>
</BaseLayout>
